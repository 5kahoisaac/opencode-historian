---
phase: 01-core-infrastructure
plan: 05
type: execute
wave: 2
depends_on:
  - 01-01
  - 01-04
files_modified:
  - src/utils/logger.ts
  - src/utils/validation.ts
  - src/utils/helpers.ts
  - src/utils/index.ts
autonomous: true

must_haves:
  truths:
    - Logger utility supports multiple log levels
    - Validation helpers for external paths exist
    - Shared helper functions exist (debounce, sanitize, truncate)
    - Utilities are shared across modules
  artifacts:
    - path: src/utils/logger.ts
      provides: Debug/logging utilities
      exports: [createLogger, Logger]
    - path: src/utils/validation.ts
      provides: Validation helpers
      exports: [validateExternalPath, isValidMemoryType]
    - path: src/utils/helpers.ts
      provides: Shared helper functions
      exports: [debounce, sanitizeFilename, truncateString, deepClone]
    - path: src/utils/index.ts
      provides: Utils module exports
  key_links:
    - from: src/utils/logger.ts
      to: PluginConfig.logLevel
      via: Log level configuration
---

<objective>
Create shared utility functions for logging, validation, and common operations.

Purpose: Centralize utilities to avoid duplication and ensure consistent behavior.
Output: Utils module with logger and validation helpers.
</objective>

<execution_context>
@./.opencode/agents/gsd-executor.md
@./.opencode/get-shit-done/workflows/execute-plan.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/01-core-infrastructure/01-CONTEXT.md
@.planning/phases/01-core-infrastructure/01-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create logger utility</name>
  <files>src/utils/logger.ts</files>
  <action>
    Create src/utils/logger.ts with logging utilities:
    
    1. Define LogLevel type: debug | info | warn | error
    2. Create Logger interface with debug/info/warn/error methods
    3. Implement createLogger(config) factory that returns Logger
    4. Logger respects config.logLevel and config.debug settings
    5. Prefix all logs with [opencode-historian]
    
    Use console methods for output. Filter messages based on level.
  </action>
  <verify>TypeScript typecheck passes</verify>
  <done>Logger utility implemented with level filtering</done>
</task>

<task type="auto">
  <name>Task 2: Create validation utilities</name>
  <files>src/utils/validation.ts</files>
  <action>
    Create src/utils/validation.ts with validation helpers:
    
    1. validateExternalPath(path: string): boolean | string
       - Reject paths with .. (directory traversal)
       - Require absolute paths
       - Return true if valid, error message if invalid
    
    2. isValidMemoryType(type: string, customTypes?: MemoryType[]): boolean
       - Check against built-in types
       - Check against custom types from config
    
    3. sanitizeIndexName(folderName: string): string
       - Convert to kebab-case
       - Remove special characters
       - Handle spaces and edge cases
  </action>
  <verify>TypeScript typecheck passes</verify>
  <done>Validation utilities implemented</done>
</task>

<task type="auto">
  <name>Task 3: Create utils index</name>
  <files>src/utils/index.ts</files>
  <action>
    Create src/utils/index.ts:
    
    1. Export all from logger.ts
    2. Export all from validation.ts
    3. Export all from helpers.ts
    
    This provides single import point for all utilities.
  </action>
  <verify>TypeScript typecheck passes</verify>
  <done>Utils module index created</done>
</task>

<task type="auto">
  <name>Task 4: Create shared helpers utility</name>
  <files>src/utils/helpers.ts</files>
  <action>
    Create src/utils/helpers.ts with shared helper functions:
    
    1. debounce<T extends (...args: any[]) => any>(fn: T, ms: number): T
       - Debounce function calls for performance
    
    2. sanitizeFilename(name: string): string
       - Remove/replace unsafe characters
       - Ensure valid filename
    
    3. truncateString(str: string, maxLen: number, suffix?: string): string
       - Truncate strings with optional suffix
    
    4. deepClone<T>(obj: T): T
       - Deep clone objects using structuredClone or fallback
    
    These are generic helpers used across the plugin.
  </action>
  <verify>TypeScript typecheck passes</verify>
  <done>Shared helpers utility implemented</done>
</task>

</tasks>

<verification>
1. Run `bun run typecheck` - must pass
2. Verify logger respects log level settings
3. Check validation rejects invalid paths
4. Verify helpers (debounce, sanitizeFilename) work correctly
</verification>

<success_criteria>
- Logger utility supports multiple log levels
- External path validation implemented
- Shared helper functions implemented (debounce, sanitizeFilename, truncateString, deepClone)
- Utils module exports all utilities
- TypeScript compilation passes
</success_criteria>

<output>
After completion, create `.planning/phases/01-core-infrastructure/01-05-SUMMARY.md`
</output>
