---
phase: 01-core-infrastructure
plan: 03
type: execute
wave: 1
depends_on: []
files_modified:
  - src/qmd/client.ts
  - src/qmd/cli.ts
  - src/qmd/index.ts
autonomous: true

must_haves:
  truths:
    - qmd MCP client wrapper exists for read operations
    - qmd CLI wrapper exists for write operations with --index flag
    - All qmd operations include the --index parameter
    - Collection operations support index naming by folder and collection naming by memory_type
  artifacts:
    - path: src/qmd/client.ts
      provides: MCP client wrapper for qmd read operations
      exports:
        - QmdClient class/interface
        - search, vectorSearch methods
    - path: src/qmd/cli.ts
      provides: CLI command builder for qmd write operations
      exports:
        - addToCollection
        - updateIndex
        - removeFromIndex
        - QmdOptions interface
    - path: src/qmd/index.ts
      provides: qmd module exports
      exports:
        - All qmd types and functions
  key_links:
    - from: src/qmd/cli.ts
      to: node:child_process
      via: exec for CLI commands
      pattern: execAsync(`qmd ...`)
    - from: src/qmd/client.ts
      to: MCP SDK
      via: mcpClient.callTool
      pattern: callTool('qmd_*')
---

<objective>
Implement qmd integration layer separating read operations (MCP tools) from write operations (CLI commands) per CONTEXT.md requirements.

Purpose: qmd powers the semantic search capabilities. This layer ensures proper index management and follows the read/write separation design principle.
Output: qmd module with MCP client for reads and CLI wrapper for writes.
</objective>

<execution_context>
@./.opencode/agents/gsd-executor.md
@./.opencode/get-shit-done/workflows/execute-plan.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/01-core-infrastructure/01-CONTEXT.md
@.planning/phases/01-core-infrastructure/01-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create qmd MCP client for reads</name>
  <files>src/qmd/client.ts</files>
  <action>
    Create src/qmd/client.ts with MCP client wrapper for read operations per RESEARCH.md Pattern 4:
    
    1. Define QmdClient interface/class with constructor taking mcpClient
    
    2. search(query: string, options: SearchOptions): Promise<SearchResult[]>
       - Wraps qmd_search MCP tool
       - Options: index (required), n (number of results)
       - Returns array of results with path, score, content
    
    3. vectorSearch(query: string, options: SearchOptions): Promise<SearchResult[]>
       - Wraps qmd_vsearch MCP tool for semantic search
       - Same options as search
       - Used for memory_recall operation
    
    4. Types:
       - SearchOptions: { index: string; n?: number }
       - SearchResult: { path: string; score: number; content?: string }
    
    CORE-06: Index naming uses folder name, collection naming uses memory_type.
    ALL operations must include --index {folder_name}.
  </action>
  <verify>TypeScript typecheck passes</verify>
  <done>MCP client wrapper implemented for read operations</done>
</task>

<task type="auto">
  <name>Task 2: Create qmd CLI wrapper for writes</name>
  <files>src/qmd/cli.ts</files>
  <action>
    Create src/qmd/cli.ts with CLI command builder for write operations per RESEARCH.md:
    
    1. Define QmdOptions interface: { index: string }  // REQUIRED per CONTEXT.md
    
    2. addToCollection(filePath: string, collectionName: string, options: QmdOptions): Promise<void>
       - Builds command: qmd collection add "{filePath}" --name {collectionName} --index {options.index}
       - Execute with exec from node:child_process (promisified)
       - Used for memory_remember operation
    
    3. updateIndex(options: QmdOptions): Promise<void>
       - Builds command: qmd update --index {options.index}
       - Must be called after ANY file modification (Pitfall 5 in RESEARCH.md)
       - Used after remember, compound, forget operations
    
    4. removeFromIndex(filePath: string, options: QmdOptions): Promise<void>
       - qmd doesn't have direct removal; just call updateIndex
       - After file deletion, updateIndex will sync the index
    
    5. Helper: execAsync using promisify(exec)
    
    CRITICAL: ALL commands MUST include --index flag (Pitfall 1 in RESEARCH.md).
    Write operations use CLI, not MCP tools per design principle.
  </action>
  <verify>TypeScript typecheck passes</verify>
  <done>CLI wrapper implemented with mandatory --index flag injection</done>
</task>

<task type="auto">
  <name>Task 3: Create qmd module index</name>
  <files>src/qmd/index.ts</files>
  <action>
    Create src/qmd/index.ts as the public API for the qmd module:
    
    1. Re-export all from client.ts:
       - QmdClient class
       - SearchOptions, SearchResult interfaces
    
    2. Re-export all from cli.ts:
       - addToCollection, updateIndex, removeFromIndex
       - QmdOptions interface
    
    This provides a single import point: import { ... } from './qmd'
    
    The separation is intentional: reads via QmdClient (MCP), writes via CLI functions.
  </action>
  <verify>TypeScript typecheck passes; all exports are accessible</verify>
  <done>qmd module fully exported with clear read/write separation</done>
</task>

</tasks>

<verification>
After completing all tasks:
1. Run `bun run typecheck` - must pass with no errors
2. Verify QmdOptions interface requires index field (no optional)
3. Check that CLI functions always include --index in commands
4. Ensure MCP client methods match qmd tool names (qmd_search, qmd_vsearch)
</verification>

<success_criteria>
- MCP client wrapper exists for read operations (search, vectorSearch)
- CLI wrapper exists for write operations with mandatory --index flag
- Index naming follows folder_name convention (CORE-06)
- Collection naming follows memory_type convention (CORE-06)
- TypeScript compilation passes
</success_criteria>

<output>
After completion, create `.planning/phases/01-core-infrastructure/01-03-SUMMARY.md`
</output>
