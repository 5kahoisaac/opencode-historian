---
phase: 01-core-infrastructure
plan: 04
type: execute
wave: 2
depends_on:
  - 01-01
  - 01-02
  - 01-03
files_modified:
  - src/agents/historian.ts
  - src/agents/index.ts
  - src/tools/memory-remember.ts
  - src/tools/memory-recall.ts
  - src/tools/memory-compound.ts
  - src/tools/memory-forget.ts
  - src/tools/index.ts
autonomous: true

must_haves:
  truths:
    - Historian agent configuration matches CONTEXT.md exactly
    - Four memory tools exist: remember, recall, compound, forget
    - Tool implementation follows qmd read/write separation
    - Write operations validate scope (only .mnemonics/)
  artifacts:
    - path: src/agents/historian.ts
      provides: Historian agent configuration
      exports:
        - createHistorianAgent
        - HistorianAgentConfig
    - path: src/agents/index.ts
      provides: Agent module exports
      exports:
        - createHistorianAgent
    - path: src/tools/memory-remember.ts
      provides: memory_remember tool implementation
      exports:
        - createRememberTool
    - path: src/tools/memory-recall.ts
      provides: memory_recall tool implementation
      exports:
        - createRecallTool
    - path: src/tools/memory-compound.ts
      provides: memory_compound tool implementation
      exports:
        - createCompoundTool
    - path: src/tools/memory-forget.ts
      provides: memory_forget tool implementation
      exports:
        - createForgetTool
    - path: src/tools/index.ts
      provides: Tools module exports
      exports:
        - createMemoryTools
  key_links:
    - from: src/tools/memory-remember.ts
      to: src/qmd/cli.ts
      via: addToCollection and updateIndex
      pattern: addToCollection(filePath, memoryType, { index })
    - from: src/tools/memory-recall.ts
      to: src/qmd/client.ts
      via: vectorSearch
      pattern: qmdClient.vectorSearch(query, { index })
    - from: src/agents/historian.ts
      to: src/tools/index.ts
      via: Tool registration
      pattern: tools: ['memory_remember', ...]
---

<objective>
Implement the Historian agent and memory CRUD tools (remember, recall, compound, forget) with proper qmd integration and scope validation.

Purpose: The Historian agent is the memory management specialist; tools provide the interface for memory operations. Tool permissions restrict memory tools to historian only.
Output: Complete agent and tools module with full CRUD operations.
</objective>

<execution_context>
@./.opencode/agents/gsd-executor.md
@./.opencode/get-shit-done/workflows/execute-plan.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/01-core-infrastructure/01-CONTEXT.md
@.planning/phases/01-core-infrastructure/01-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Historian agent configuration</name>
  <files>src/agents/historian.ts, src/agents/index.ts</files>
  <action>
    Create src/agents/historian.ts per CONTEXT.md Historian Agent Configuration:
    
    1. createHistorianAgent(config: PluginConfig): AgentConfig
       Returns agent configuration object:
       - name: 'historian'
       - model: config.model || 'opencode/kimi-k2.5-free'
       - fallbackModels: ['opencode/gpt-5-nano', 'opencode/big-pickle']
       - temperature: config.temperature ?? 0.3
       - description: 'Memory management specialist for contextual information'
       - tools: ['memory_remember', 'memory_recall', 'memory_compound', 'memory_forget']
       - appendPrompt: config.appendPrompt
    
    2. Create src/agents/index.ts:
       - Export createHistorianAgent
       - This is the public API
    
    STRC-01: agents/ — Historian agent runs as OpenCode subagent.
  </action>
  <verify>TypeScript typecheck passes; agent config matches CONTEXT.md</verify>
  <done>Historian agent configured with correct models and tools</done>
</task>

<task type="auto">
  <name>Task 2: Create memory_recall tool</name>
  <files>src/tools/memory-recall.ts</files>
  <action>
    Create src/tools/memory-recall.ts:
    
    1. createRecallTool(qmdClient: QmdClient, config: PluginConfig)
       Returns tool definition:
       - name: 'memory_recall'
       - description: 'Search memories using semantic similarity'
       - parameters: { query: string, limit?: number }
       - handler: async ({ query, limit }) => {
           const results = await qmdClient.vectorSearch(query, {
             index: getIndexName(),
             n: limit || 10
           });
           return { memories: results };
         }
    
    2. Scope: Can access ALL sources (read-only, safe)
    3. Uses MCP qmd_vsearch
    4. Delegatable: Yes
  </action>
  <verify>TypeScript typecheck passes</verify>
  <done>memory_recall tool implemented</done>
</task>

<task type="auto">
  <name>Task 3: Create memory_remember tool</name>
  <files>src/tools/memory-remember.ts</files>
  <action>
    Create src/tools/memory-remember.ts:
    
    1. createRememberTool(config: PluginConfig, projectRoot: string)
       Returns tool definition:
       - name: 'memory_remember'
       - parameters: { title: string, content: string, memoryType: string, tags?: string[] }
       - handler validates scope (only .mnemonics/)
       - Creates file with frontmatter
       - Calls addToCollection and updateIndex
    
    2. Scope: .mnemonics only
    3. Uses CLI for writes
    4. Delegatable: No
    
    STRC-02: tools/memory/ — Memory CRUD tools.
  </action>
  <verify>TypeScript typecheck passes; scope validation implemented</verify>
  <done>memory_remember tool implemented</done>
</task>

<task type="auto">
  <name>Task 4: Create memory_compound tool</name>
  <files>src/tools/memory-compound.ts</files>
  <action>
    Create src/tools/memory-compound.ts:
    
    1. createCompoundTool(qmdClient: QmdClient, config: PluginConfig, projectRoot: string)
       Returns tool definition:
       - name: 'memory_compound'
       - parameters: { query: string, newContent: string }
       - handler:
         a) Search for existing memory with qmdClient.search
         b) Read found file with parseMemoryFile
         c) Append/modify content
         d) Write back with writeMemoryFile
         e) Update index with updateIndex
    
    2. Scope: .mnemonics only
    3. Uses MCP for search, CLI for update
    4. Delegatable: No
  </action>
  <verify>TypeScript typecheck passes</verify>
  <done>memory_compound tool implemented</done>
</task>

<task type="auto">
  <name>Task 5: Create memory_forget tool</name>
  <files>src/tools/memory-forget.ts</files>
  <action>
    Create src/tools/memory-forget.ts:
    
    1. createForgetTool(qmdClient: QmdClient, config: PluginConfig, projectRoot: string)
       Returns tool definition:
       - name: 'memory_forget'
       - parameters: { query: string }
       - handler:
         a) Search for memory with qmdClient.search
         b) Confirm deletion (return options to user)
         c) Delete file with fs.unlink
         d) Update index with updateIndex
    
    2. Scope: .mnemonics only
    3. Uses MCP for search, CLI for update
    4. Delegatable: No
  </action>
  <verify>TypeScript typecheck passes</verify>
  <done>memory_forget tool implemented</done>
</task>

<task type="auto">
  <name>Task 6: Create tools module index</name>
  <files>src/tools/index.ts</files>
  <action>
    Create src/tools/index.ts:
    
    1. Import all tool creators
    2. Export createMemoryTools function that returns all tools
    3. Export individual tool creators
    
    Returns object with all four memory tools ready for plugin registration.
  </action>
  <verify>TypeScript typecheck passes; all tools exported</verify>
  <done>Tools module index created</done>
</task>

</tasks>

<verification>
After completing all tasks:
1. Run `bun run typecheck` - must pass
2. Verify all four tools are exported
3. Check that write tools validate scope
4. Confirm agent config matches CONTEXT.md
</verification>

<success_criteria>
- Historian agent configured correctly (STRC-01)
- Four memory tools implemented (STRC-02)
- Scope validation on write tools
- qmd integration follows read/write separation
- TypeScript compilation passes
</success_criteria>

<output>
After completion, create `.planning/phases/01-core-infrastructure/01-04-SUMMARY.md`
</output>
