---
phase: 01-core-infrastructure
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - src/storage/paths.ts
  - src/storage/files.ts
  - src/storage/index.ts
autonomous: true

must_haves:
  truths:
    - Global memory path resolves to ~/.config/opencode/mnemonics/
    - Project memory path resolves to {projectRoot}/.mnemonics/
    - Memory files can be created with YAML frontmatter
    - Memory files can be read and parsed with frontmatter extraction
    - Filename generation converts titles to kebab-case
  artifacts:
    - path: src/storage/paths.ts
      provides: Path resolution for global and project storage
      exports:
        - getGlobalMemoryPath
        - getProjectMemoryPath
        - ensureDirectory
        - isWithinProjectMnemonics
    - path: src/storage/files.ts
      provides: Memory file CRUD with YAML frontmatter
      exports:
        - createMemoryFile
        - parseMemoryFile
        - writeMemoryFile
        - generateFilename
        - MemoryFile interface
        - MemoryMetadata interface
    - path: src/storage/index.ts
      provides: Storage module exports
      exports:
        - All storage types and functions
  key_links:
    - from: src/storage/files.ts
      to: gray-matter
      via: matter() for parsing/stringifying
      pattern: import matter from 'gray-matter'
    - from: src/storage/paths.ts
      to: node:path/node:os
      via: Path resolution
      pattern: path.join(os.homedir(), ...)
---

<objective>
Implement storage infrastructure with path resolution (global and project-scoped) and file operations supporting YAML frontmatter format.

Purpose: All memory data lives in markdown files with YAML frontmatter. This layer handles where files live and how they're read/written.
Output: Complete storage module with path utilities and file operations.
</objective>

<execution_context>
@./.opencode/agents/gsd-executor.md
@./.opencode/get-shit-done/workflows/execute-plan.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/01-core-infrastructure/01-CONTEXT.md
@.planning/phases/01-core-infrastructure/01-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create storage path utilities</name>
  <files>src/storage/paths.ts</files>
  <action>
    Create src/storage/paths.ts with path resolution functions per RESEARCH.md:
    
    1. getGlobalMemoryPath(): string
       - Returns ~/.config/opencode/mnemonics  // CORE-02
       - Use path.join(os.homedir(), '.config', 'opencode', 'mnemonics')
    
    2. getProjectMemoryPath(projectRoot: string): string
       - Returns {projectRoot}/.mnemonics  // CORE-03
       - Use path.join(projectRoot, '.mnemonics')
    
    3. ensureDirectory(dirPath: string): void
       - Creates directory recursively if it doesn't exist
       - Use fs.mkdirSync(dirPath, { recursive: true })
    
    4. isWithinProjectMnemonics(filePath: string, projectRoot: string): boolean
       - Validates that filePath is within {projectRoot}/.mnemonics
       - Use path.resolve() on both paths and check startsWith
       - Critical for write scope validation (Pitfall 4 in RESEARCH.md)
    
    Import from node:path, node:os, node:fs.
  </action>
  <verify>TypeScript typecheck passes</verify>
  <done>All path utilities implemented with proper platform handling</done>
</task>

<task type="auto">
  <name>Task 2: Create memory file operations</name>
  <files>src/storage/files.ts</files>
  <action>
    Create src/storage/files.ts with file operations per RESEARCH.md Pattern 5:
    
    1. Define interfaces:
       - MemoryMetadata: id, created, modified, memory_type, tags?, related?
       - MemoryFile: content (string), data (MemoryMetadata)
    
    2. createMemoryFile(content, memoryType, tags?): MemoryFile
       - Generate UUID using crypto.randomUUID()
       - Set created and modified to new Date().toISOString()
       - Return MemoryFile object ready to write
    
    3. parseMemoryFile(filePath: string): MemoryFile
       - Read file with fs.readFileSync
       - Parse with gray-matter: matter(content)
       - Return { content: parsed.content, data: parsed.data }
    
    4. writeMemoryFile(filePath: string, memory: MemoryFile): void
       - Use matter.stringify(memory.content, memory.data)
       - Write with fs.writeFileSync
    
    5. generateFilename(title: string): string
       - Convert to lowercase
       - Replace non-alphanumeric with hyphens
       - Trim leading/trailing hyphens
       - Add .md extension
       - Example: "My Decision" â†’ "my-decision.md"
    
    CORE-04: Markdown files with YAML frontmatter format.
  </action>
  <verify>TypeScript typecheck passes; matter imports correctly</verify>
  <done>File operations implemented with gray-matter integration</done>
</task>

<task type="auto">
  <name>Task 3: Create storage module index</name>
  <files>src/storage/index.ts</files>
  <action>
    Create src/storage/index.ts as the public API for the storage module:
    
    1. Re-export all from paths.ts:
       - getGlobalMemoryPath, getProjectMemoryPath
       - ensureDirectory, isWithinProjectMnemonics
    
    2. Re-export all from files.ts:
       - createMemoryFile, parseMemoryFile, writeMemoryFile, generateFilename
       - MemoryFile interface, MemoryMetadata interface
    
    3. Add any additional storage types needed for future expansion.
    
    This provides a single import point: import { ... } from './storage'
  </action>
  <verify>TypeScript typecheck passes; all exports are accessible</verify>
  <done>Storage module fully exported and ready for use</done>
</task>

</tasks>

<verification>
After completing all tasks:
1. Run `bun run typecheck` - must pass with no errors
2. Verify path functions return correct paths on your platform
3. Test isWithinProjectMnemonics with various paths (inside, outside, edge cases)
4. Verify gray-matter integration works (can stringify/parse frontmatter)
</verification>

<success_criteria>
- Global memory path resolves correctly (CORE-02)
- Project memory path resolves correctly (CORE-03)
- Memory files support YAML frontmatter (CORE-04)
- Filename generation converts titles to kebab-case
- TypeScript compilation passes
</success_criteria>

<output>
After completion, create `.planning/phases/01-core-infrastructure/01-02-SUMMARY.md`
</output>
